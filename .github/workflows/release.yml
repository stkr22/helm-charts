name: Release Charts
# only run one instance of this workflow at a time
# ref: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#concurrency
concurrency: chart_releaser

on:
  push:
    branches:
      - main
    paths:
      - charts/**

jobs:
  release:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1 # v6.0.1
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4.3.1 # v4.3.1

      - name: Detect changed charts
        id: changed
        run: |
          # Find charts that have changed in this push or don't have a release yet
          changed_charts=()

          for chart_dir in charts/*/; do
            chart=$(basename "$chart_dir")
            chart_file="${chart_dir}Chart.yaml"

            if [[ ! -f "$chart_file" ]]; then
              continue
            fi

            # Extract version from Chart.yaml
            version=$(grep '^version:' "$chart_file" | awk '{print $2}' | tr -d '[:space:]')
            tag="${chart}-${version}"

            # Check if this version tag already exists
            if git rev-parse "$tag" >/dev/null 2>&1; then
              echo "Release $tag already exists, skipping..."
            else
              echo "New version detected: $tag"
              changed_charts+=("$chart_dir")
            fi
          done

          if [[ ${#changed_charts[@]} -gt 0 ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "charts<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "${changed_charts[@]}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No new chart versions to release"
          fi

      - name: Package changed charts
        if: steps.changed.outputs.changed == 'true'
        run: |
          mkdir -p .cr-release-packages
          for chart in ${{ steps.changed.outputs.charts }}; do
            echo "Packaging $chart..."
            helm package "$chart" --destination .cr-release-packages
          done

      - name: Create GitHub releases
        if: steps.changed.outputs.changed == 'true'
        run: |
          for pkg in .cr-release-packages/*.tgz; do
            chart_name=$(basename "$pkg" .tgz)
            # Extract version from package name (format: chartname-version.tgz)
            version=$(echo "$chart_name" | grep -oP '(?<=-)[0-9]+\.[0-9]+\.[0-9]+$')
            chart=$(echo "$chart_name" | sed "s/-${version}$//")

            echo "Creating release for $chart version $version"
            gh release create "${chart}-${version}" "$pkg" \
              --title "${chart} ${version}" \
              --generate-notes \
              || echo "Release ${chart}-${version} already exists, skipping..."
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        if: steps.changed.outputs.changed == 'true'
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push charts to OCI registry
        if: steps.changed.outputs.changed == 'true'
        run: |
          for pkg in .cr-release-packages/*.tgz; do
            echo "Pushing $pkg to OCI registry..."
            helm push "$pkg" oci://ghcr.io/${{ github.repository }}
          done
